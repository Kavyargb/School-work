<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IUPAC to Structure Renderer</title>
    <style>
#input-container {
    display: flex;
    gap: 12px;
    margin-bottom: 24px;
    align-items: center;
    flex-wrap: wrap;
}

#iupac-input {
    flex-grow: 1;
    padding: 10px 14px;
    font-size: 16px;
    border: 1px solid #ccc;
    border-radius: 6px;
    transition: border-color 0.2s, box-shadow 0.2s;
}

#iupac-input:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.2);
}

#convert-btn {
    padding: 10px 22px;
    font-size: 16px;
    background-color: #007bff;
    color: #fff;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.2s, transform 0.1s;
}

#convert-btn:hover {
    background-color: #0056b3;
}

#convert-btn:active {
    transform: scale(0.97);
}

#convert-btn:disabled {
    background-color: #aaa;
    cursor: not-allowed;
}

#status {
    margin: 20px 0;
    padding: 12px 16px;
    border-radius: 6px;
    font-style: italic;
    font-size: 15px;
}

.status-info {
    background-color: #e6f7ff;
    border-left: 4px solid #007bff;
    color: #004085;
}

.status-error {
    background-color: #ffebe6;
    border-left: 4px solid #d9534f;
    color: #d9534f;
}

#results {
    margin-top: 24px;
    padding: 16px;
    border: 1px solid #eee;
    border-radius: 6px;
    min-height: 300px;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
    background-color: #fff;
}

#smiles-output {
    font-family: "Courier New", Courier, monospace;
    background-color: #f5f5f5;
    padding: 10px;
    border-radius: 5px;
    word-break: break-word;
    font-size: 14px;
    color: #333;
}

#structure-image-container {
    margin-top: 20px;
    text-align: center;
}

    </style>
        <link rel="stylesheet" href="../style_light.css">

</head>
<body class="body-content">
    <!-- Top navigation bar placeholder -->
    <nav class="global-nav" id="global-navbar"></nav>
    
    <!-- Sidebar placeholder -->
    <nav id="index-sidebar"></nav>

    <script src="../nav.js"></script>

    <main class="main-content">

        <h1>IUPAC to Structure with RDKit.js</h1>
        <p>Enter a chemical name (IUPAC, common name, or CAS number) to get its SMILES string and rendered 2D structure.</p>
    
        <div id="input-container">
            <input type="text" id="iupac-input" placeholder="e.g., caffeine, 2-propanol, ethanol">
            <button id="convert-btn" disabled>Loading RDKit...</button>
        </div>
    
        <div id="status"></div>
    
        <div id="results" style="display: none;">
            <h2>Results</h2>
            <p><strong>Resolved SMILES:</strong></p>
            <pre id="smiles-output"></pre>
            <div id="structure-image-container">
                <!-- RDKit.js will insert the SVG here -->
            </div>
        </div>
    </main>

    <!-- 1. Include RDKit.js from a CDN -->
    <script src="https://unpkg.com/@rdkit/rdkit/dist/RDKit_minimal.js"></script>

    <script>
        // Use a self-invoking async function to handle the top-level 'await'
        (async () => {
            // --- UI Elements ---
            const iupacInput = document.getElementById('iupac-input');
            const convertBtn = document.getElementById('convert-btn');
            const statusDiv = document.getElementById('status');
            const resultsDiv = document.getElementById('results');
            const smilesOutput = document.getElementById('smiles-output');
            const imageContainer = document.getElementById('structure-image-container');

            let rdkit = null; // To hold the RDKit module instance

            // --- RDKit Initialization ---
            try {
                // initRDKitModule is a global function from the RDKit script
                rdkit = await initRDKitModule();
                console.log("RDKit module initialized.");
                convertBtn.disabled = false;
                convertBtn.textContent = 'Convert';
                setStatus('RDKit.js loaded successfully. Ready to convert.', 'info');
            } catch (e) {
                console.error("Error loading RDKit module:", e);
                setStatus('Failed to load RDKit.js module. This tool will not work.', 'error');
                return; // Stop execution if RDKit fails to load
            }

            // --- Event Listeners ---
            convertBtn.addEventListener('click', handleConversion);
            iupacInput.addEventListener('keyup', (event) => {
                if (event.key === 'Enter') {
                    handleConversion();
                }
            });

            // --- Main Conversion Logic ---
            async function handleConversion() {
                const iupacName = iupacInput.value.trim();
                if (!iupacName) {
                    setStatus('Please enter a chemical name.', 'error');
                    return;
                }

                // Reset UI for new conversion
                clearResults();
                setStatus('1. Resolving name to SMILES...', 'info');
                convertBtn.disabled = true;

                try {
                    // --- Step 1: IUPAC Name to SMILES via API ---
                    const smiles = await nameToSmiles(iupacName);
                    smilesOutput.textContent = smiles;
                    resultsDiv.style.display = 'block';
                    
                    setStatus('2. Rendering structure from SMILES...', 'info');

                    // --- Step 2: SMILES to Structure Image with RDKit.js ---
                    renderStructure(smiles);
                    setStatus('Conversion complete!', 'info');

                } catch (error) {
                    console.error("Conversion failed:", error);
                    setStatus(error.message, 'error');
                    resultsDiv.style.display = 'none'; // Hide results on failure
                } finally {
                    convertBtn.disabled = false; // Re-enable button
                }
            }
            
            // --- Helper Functions ---

            /**
             * Fetches SMILES string from NIH Chemical Identifier Resolver.
             * @param {string} name - The chemical name to resolve.
             * @returns {Promise<string>} A promise that resolves to the SMILES string.
             */
            async function nameToSmiles(name) {
                const url = `https://cactus.nci.nih.gov/chemical/structure/${encodeURIComponent(name)}/smiles`;
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Could not resolve "${name}". The API returned an error (status: ${response.status}). Is the name correct?`);
                }
                const smiles = await response.text();
                // API returns the name itself on a new line if it fails, so we check for that
                if (smiles.includes('\n') || smiles.trim() === '') {
                   throw new Error(`Could not find a structure for "${name}".`);
                }
                return smiles;
            }

            /**
             * Renders a molecule from a SMILES string and displays it.
             * @param {string} smiles - The SMILES string.
             */
            function renderStructure(smiles) {
                // RDKit can throw an error for invalid SMILES, so we use a try-catch
                try {
                    const mol = rdkit.get_mol(smiles);
                    
                    // Generate the SVG with some drawing options
                    const svg = mol.get_svg(300, 300); // width, height
                    imageContainer.innerHTML = svg;

                    // IMPORTANT: Free the memory used by the molecule object
                    mol.delete();
                } catch (e) {
                    console.error("RDKit rendering error:", e);
                    throw new Error("Failed to render the molecule. The SMILES string might be invalid.");
                }
            }

            /**
             * Updates the status message for the user.
             * @param {string} message - The text to display.
             * @param {'info'|'error'} type - The type of message.
             */
            function setStatus(message, type = 'info') {
                statusDiv.textContent = message;
                statusDiv.className = `status status-${type}`;
            }

            /**
             * Clears previous results from the UI.
             */
            function clearResults() {
                statusDiv.textContent = '';
                statusDiv.className = 'status';
                smilesOutput.textContent = '';
                imageContainer.innerHTML = '';
                resultsDiv.style.display = 'none';
            }

        })();
    </script>
</body>
</html>